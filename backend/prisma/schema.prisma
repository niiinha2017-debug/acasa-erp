generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model usuarios {
  id            Int      @id @default(autoincrement())
  nome          String
  usuario       String   @unique
  email         String   @unique
  setor         String
  funcao        String
  senha         String
  status        String
  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  recuperacoes recuperacao_senha[] // ‚úÖ lado oposto da rela√ß√£o
  permissoes usuarios_permissoes[]


  @@map("usuarios")
}

model recuperacao_senha {
  id           Int      @id @default(autoincrement())
  usuario_id   Int
  email        String
  senha_antiga String?
  senha_nova   String?
  token        String?
  utilizado    Boolean  @default(false)
  criado_em    DateTime @default(now())

  usuario usuarios @relation(fields: [usuario_id], references: [id])

  @@map("recuperacao_senha")
}


model Cliente {
  id Int @id @default(autoincrement())

  indicacao_id Int?
  indicacao    Cliente?  @relation("ClienteIndicacao", fields: [indicacao_id], references: [id])
  indicados    Cliente[] @relation("ClienteIndicacao")

  nome_completo   String
  razao_social    String?
  data_nascimento DateTime

  cpf  String?
  rg   String?
  cnpj String?
  ie   String?

  telefone String?
  whatsapp String?
  email    String

  enviar_aniversario_email    Boolean @default(true)
  enviar_aniversario_whatsapp Boolean @default(false)

  cep      String?
  endereco String?
  numero   String?
  complemento String?
  bairro   String?
  cidade   String?
  estado   String?

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  orcamentos orcamentos[]
  vendas     vendas[]

  @@unique([cpf])
  @@unique([cnpj])
  @@unique([email])
  @@index([indicacao_id])
  @@map("clientes")
}

model Fornecedores {
  id              Int      @id @default(autoincrement())
  razao_social    String
  nome_fantasia   String
  cnpj            String   @unique
  ie              String?
  telefone        String?
  whatsapp        String?
  email           String?
  cep             String?
  endereco        String?
  numero          String?
  bairro          String?
  cidade          String?
  estado          String?
  forma_pagamento String?
  data_vencimento Int?
  criado_em       DateTime @default(now())
  atualizado_em   DateTime @updatedAt

  produtos         produtos[] // üëà LADO OPOSTO DA RELA√á√ÉO
  plano_corte      plano_corte[]
  plano_corte_item plano_corte_item[]

  // ===== Financeiro (Fornecedor) =====
  contas_pagar            contas_pagar[]            @relation("contas_pagar_fornecedor")
  contas_pagar_cobrador   contas_pagar[]            @relation("contas_pagar_fornecedor_cobrador")
  contas_receber          contas_receber[]          @relation("contas_receber_fornecedor")
  compensacoes_fornecedor fornecedor_compensacoes[]
  compras                 compras[]

  @@map("fornecedores")
}

model produtos {
  id Int @id @default(autoincrement())

  fornecedor_id Int
  fornecedor    Fornecedores @relation(fields: [fornecedor_id], references: [id])

  nome_produto String
  marca        String?      // ‚úÖ NOVO
  cor          String?
  medida       String?
  unidade      String?

  quantidade     Int
  valor_unitario Decimal @db.Decimal(10, 2)
  valor_total    Decimal @db.Decimal(10, 2)

  status String

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  plano_corte_consumo plano_corte_consumo[]
  compras_itens compras_itens[]

  @@index([fornecedor_id])
  @@map("produtos")
}

model plano_corte {
  id            Int      @id @default(autoincrement())
  fornecedor_id Int
  data_venda    DateTime

  valor_total Decimal @db.Decimal(10, 2)
  status      String

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  fornecedor Fornecedores @relation(fields: [fornecedor_id], references: [id])

  produtos plano_corte_produto[]
  consumos plano_corte_consumo[]

  @@map("plano_corte")
}

model plano_corte_item {
  id            Int @id @default(autoincrement())
  fornecedor_id Int

  nome_produto String
  marca        String?      // ‚úÖ NOVO
  cor          String?
  medida       String?
  unidade      String?

  quantidade     Int
  valor_unitario Decimal @db.Decimal(10, 2)
  valor_total    Decimal @db.Decimal(10, 2)

  status String

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  ultimo_valor_vendido Decimal   @default(0.00) @db.Decimal(10, 2)
  ultimo_vendido_em    DateTime?

  fornecedor Fornecedores @relation(fields: [fornecedor_id], references: [id])

  produtos plano_corte_produto[]

  @@index([fornecedor_id])
  @@map("plano_corte_item")
}

model plano_corte_produto {
  id             Int @id @default(autoincrement())
  plano_corte_id Int
  item_id        Int

  quantidade     Decimal @db.Decimal(10, 2)
  valor_unitario Decimal @db.Decimal(10, 2)
  valor_total    Decimal @db.Decimal(10, 2)
  status         String

  plano_corte plano_corte      @relation(fields: [plano_corte_id], references: [id])
  item        plano_corte_item @relation(fields: [item_id], references: [id])

  @@map("plano_corte_produto")
}

model plano_corte_consumo {
  id             Int @id @default(autoincrement())
  plano_corte_id Int
  produto_id     Int // üëà produto J√Å EXISTENTE (compras)

  quantidade Decimal @db.Decimal(10, 2) // METRO usado

  criado_em DateTime @default(now())

  plano_corte plano_corte @relation(fields: [plano_corte_id], references: [id])
  produto     produtos    @relation(fields: [produto_id], references: [id])

  @@map("plano_corte_consumo")
}

model funcionarios {
  id Int @id @default(autoincrement())

  // ======================
  // DADOS PESSOAIS
  // ======================
  nome            String
  cpf             String    @unique
  rg              String?
  data_nascimento DateTime?
  telefone        String?
  whatsapp        String?
  email           String?
  estado_civil    String?
  escolaridade    String?

  // ======================
  // DADOS DA EMPRESA
  // ======================
  setor           String?
  cargo           String?
  funcao          String?

  // ======================
  // ENDERE√áO
  // ======================
  cep             String?
  endereco        String?
  numero          String?
  complemento     String?   // <--- ADICIONADO AQUI
  bairro          String?
  cidade          String?
  estado          String?

  // ======================
  // REGISTRO / V√çNCULO (Essencial para c√°lculo de F√©rias)
  // ======================
  registro        String?
  admissao        DateTime?
  demissao        DateTime?

  // ======================
  // FINANCEIRO
  // ======================
  salario_base        Decimal? @db.Decimal(12, 2)
  salario_adicional   Decimal? @db.Decimal(12, 2)
  custo_hora          Decimal? @db.Decimal(12, 2)
  
  tem_vale            Boolean  @default(false)
  vale                Decimal? @db.Decimal(12, 2)

  tem_vale_transporte Boolean  @default(false)
  vale_transporte     Decimal? @db.Decimal(12, 2)

  // ======================
  // HOR√ÅRIOS (Armazenados como String: "08:00")
  // ======================
  horario_entrada_1   String?
  horario_saida_1     String?
  horario_entrada_2   String?
  horario_saida_2     String?

  // ======================
  // PAGAMENTO
  // ======================
  forma_pagamento     String?
  data_pagamento      DateTime?
  banco               String?
  agencia             String?
  conta               String?
  pix_tipo_chave      String?
  pix_chave           String?

  // ======================
  // PRODU√á√ÉO / DESPESAS
  // ======================
  despesas            despesas[]
  producao_tarefas    producao_tarefas[]
  custo_hora_producao Decimal            @default(0.00) @db.Decimal(10, 2)

  // ======================
  // CONTROLE
  // ======================
  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  @@map("funcionarios")
}


model constantes {
  id            Int      @id @default(autoincrement())
  
  // Identificadores
  categoria     String   // Ex: 'FORMA_PAGAMENTO', 'STATUS_PRODUCAO'
  chave         String   // Ex: 'CARTAO_CREDITO_VISA', 'EM_ABERTO'
  rotulo        String   // Ex: 'Cart√£o de Cr√©dito (Visa)'
  
  // Valores (Unificamos para facilitar)
  valor_texto   String?  // Para descri√ß√µes ou observa√ß√µes extras
  valor_numero  Decimal? @db.Decimal(12, 2) // üëà PERFEITO para Taxas (Ex: 3.50 para 3.5%)
  
  // Organiza√ß√£o
  ordem         Int      @default(0)
  ativo         Boolean  @default(true)

  // Auditoria
  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  @@index([categoria, ativo, ordem])
  @@map("constantes")
}

model despesas {
  id Int @id @default(autoincrement())

  tipo_movimento String
  categoria      String
  classificacao  String
  local          String
  valor_total    Decimal @db.Decimal(10, 2)
  forma_pagamento String
  quantidade_parcelas Int

  data_registro   DateTime  @default(now())
  data_vencimento DateTime
  data_pagamento  DateTime?

  funcionario_id Int?
  funcionario    funcionarios? @relation(fields: [funcionario_id], references: [id])

  status String

  // ‚úÖ RECORR√äNCIA
  recorrencia_id String?  @db.VarChar(36)
  parcela_numero Int?

  @@index([recorrencia_id])
  @@index([tipo_movimento])
  @@index([categoria])
  @@index([classificacao])
  @@index([local])
  @@index([status])
  @@index([data_vencimento])
  @@index([funcionario_id])
  @@map("despesas")
}

model orcamentos {
  id Int @id @default(autoincrement())

  cliente_id Int
  cliente    Cliente @relation(fields: [cliente_id], references: [id])

  cliente_nome_snapshot String
  cliente_cpf_snapshot  String

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  itens    orcamento_itens[]
  arquivos orcamento_arquivos[]

  vendas vendas[]

  @@index([cliente_id])
  @@map("orcamentos")
}

model orcamento_itens {
  id           Int        @id @default(autoincrement())
  orcamento_id Int
  orcamento    orcamentos @relation(fields: [orcamento_id], references: [id], onDelete: Cascade)

  nome_ambiente  String
  descricao      String
  valor_unitario Decimal @db.Decimal(10, 2)
  valor_total    Decimal @db.Decimal(10, 2)

  criado_em DateTime @default(now())

  @@map("orcamento_itens")
}

model orcamento_arquivos {
  id           Int        @id @default(autoincrement())
  orcamento_id Int
  orcamento    orcamentos @relation(fields: [orcamento_id], references: [id], onDelete: Cascade)

  nome_original String
  mime_type     String
  tamanho       Int
  caminho       String // ex: uploads/orcamentos/123/arquivo.pdf

  criado_em DateTime @default(now())

  @@map("orcamento_arquivos")
}

model vendas {
  id Int @id @default(autoincrement())

  // v√≠nculo
  cliente_id Int
  cliente    Cliente @relation(fields: [cliente_id], references: [id])

  // venda pode nascer de um or√ßamento
  orcamento_id Int?
  orcamento    orcamentos? @relation(fields: [orcamento_id], references: [id])

  // status via constantes (ex: RASCUNHO, FECHADA, CANCELADA)
  status String

  data_venda DateTime @default(now())
  observacao String?

  // forma de pagamento (chave da constante)
  forma_pagamento_chave String?

  // totais (base)
  valor_bruto Decimal @default(0.00) @db.Decimal(10, 2)

  // p√≥s-venda (taxas/markup)
  taxa_pagamento_percentual_aplicado Decimal? @db.Decimal(5, 2)
  valor_taxa_pagamento               Decimal  @default(0.00) @db.Decimal(10, 2)

  taxa_nota_fiscal_percentual_aplicado Decimal? @db.Decimal(5, 2)
  valor_nota_fiscal                    Decimal  @default(0.00) @db.Decimal(10, 2)

  valor_total Decimal @default(0.00) @db.Decimal(10, 2)

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  itens     vendas_itens[]
  comissoes vendas_comissoes[]

  compras compras[] // ‚úÖ NOVO (oposto)

  @@index([cliente_id])
  @@index([orcamento_id])
  @@index([status])
  @@map("vendas")
}

model vendas_itens {
  id Int @id @default(autoincrement())

  venda_id Int
  venda    vendas @relation(fields: [venda_id], references: [id], onDelete: Cascade)

  // item ‚Äúcongelado‚Äù na venda
  nome_ambiente String
  descricao     String

  quantidade     Decimal @default(1.00) @db.Decimal(10, 2)
  valor_unitario Decimal @db.Decimal(10, 2)
  valor_total    Decimal @db.Decimal(10, 2)

  compras compras[] // ‚úÖ NOVO (oposto, se usar venda_item_id)

  criado_em DateTime @default(now())

  @@index([venda_id])
  @@map("vendas_itens")
}

model vendas_comissoes {
  id Int @id @default(autoincrement())

  venda_id Int
  venda    vendas @relation(fields: [venda_id], references: [id], onDelete: Cascade)

  // chave da constante: VENDEDOR / ARQUITETO / PROJETISTA
  tipo_comissao_chave String

  // snapshot aplicado no dia (ex: 3 / 5 / 10)
  percentual_aplicado Decimal @db.Decimal(5, 2)

  // valor calculado
  valor_comissao Decimal @default(0.00) @db.Decimal(10, 2)

  // opcional: quem √© (nome, ou depois vira v√≠nculo com usuario/funcionario)
  responsavel_nome String?

  criado_em DateTime @default(now())

  @@index([venda_id])
  @@index([tipo_comissao_chave])
  @@map("vendas_comissoes")
}

model producao_projetos {
  id Int @id @default(autoincrement())

  origem_tipo String
  origem_id   Int

  status String @default("ABERTO")

  encaminhado_em DateTime? // <<< novo (data que foi enviado pra produ√ß√£o)

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  tarefas producao_tarefas[]

  @@unique([origem_tipo, origem_id])
  @@index([origem_tipo])
  @@index([origem_id])
  @@index([status])
  @@index([encaminhado_em])
  @@map("producao_projetos")
}

model producao_tarefas {
  id Int @id @default(autoincrement())

  projeto_id Int
  projeto    producao_projetos @relation(fields: [projeto_id], references: [id], onDelete: Cascade)

  funcionario_id Int
  funcionario    funcionarios @relation(fields: [funcionario_id], references: [id])

  titulo     String
  status     String  @default("PENDENTE")
  observacao String?

  inicio_em DateTime
  fim_em    DateTime

  // CPV (snapshot)
  custo_hora_aplicado Decimal @default(0.00) @db.Decimal(12, 2)
  custo_total         Decimal @default(0.00) @db.Decimal(12, 2)

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  @@index([projeto_id])
  @@index([funcionario_id])
  @@index([status])
  @@index([inicio_em])
  @@index([fim_em])
  @@map("producao_tarefas")
}

model contas_pagar {
  id Int @id @default(autoincrement())

  // Fornecedor "centro" (ex: Cityfer)
  fornecedor_id Int
  fornecedor    Fornecedores @relation("contas_pagar_fornecedor", fields: [fornecedor_id], references: [id])

  // Fornecedor "cobrador" (ex: Rimad) - opcional
  fornecedor_cobrador_id Int?
  fornecedor_cobrador    Fornecedores? @relation("contas_pagar_fornecedor_cobrador", fields: [fornecedor_cobrador_id], references: [id])

  // Origem (opcional) para rastrear de onde veio (compra, etc.)
  origem_tipo String?
  origem_id   Int?

  descricao  String?
  observacao String?

  // valores
  valor_original   Decimal @default(0.00) @db.Decimal(12, 2)
  valor_compensado Decimal @default(0.00) @db.Decimal(12, 2)

  // status e forma de pagamento (vem das CONSTANTES)
  status                String
  forma_pagamento_chave String?

  // parcelamento (cart√£o/cheque em 6 meses)
  parcelas_total Int?
  parcela_numero Int?

  vencimento_em DateTime
  pago_em       DateTime?

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  compensacoes fornecedor_compensacoes[] @relation("compensacoes_pagar")

  @@index([fornecedor_id])
  @@index([fornecedor_cobrador_id])
  @@index([status])
  @@index([vencimento_em])
  @@index([origem_tipo])
  @@index([origem_id])
  @@map("contas_pagar")
}

model contas_receber {
  id Int @id @default(autoincrement())

  // Fornecedor "centro" (ex: Cityfer)
  fornecedor_id Int
  fornecedor    Fornecedores @relation("contas_receber_fornecedor", fields: [fornecedor_id], references: [id])

  // Origem (ex: PLANO_CORTE)
  origem_tipo String?
  origem_id   Int?

  descricao  String?
  observacao String?

  valor_original   Decimal @default(0.00) @db.Decimal(12, 2)
  valor_compensado Decimal @default(0.00) @db.Decimal(12, 2)

  // status e forma de recebimento (vem das CONSTANTES)
  status                  String
  forma_recebimento_chave String?

  vencimento_em DateTime?
  recebido_em   DateTime?

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  compensacoes fornecedor_compensacoes[] @relation("compensacoes_receber")

  @@index([fornecedor_id])
  @@index([status])
  @@index([vencimento_em])
  @@index([origem_tipo])
  @@index([origem_id])
  @@map("contas_receber")
}

model fornecedor_compensacoes {
  id Int @id @default(autoincrement())

  fornecedor_id Int
  fornecedor    Fornecedores @relation(fields: [fornecedor_id], references: [id])

  conta_pagar_id Int
  conta_pagar    contas_pagar @relation("compensacoes_pagar", fields: [conta_pagar_id], references: [id], onDelete: Cascade)

  conta_receber_id Int
  conta_receber    contas_receber @relation("compensacoes_receber", fields: [conta_receber_id], references: [id], onDelete: Cascade)

  valor            Decimal  @default(0.00) @db.Decimal(12, 2)
  data_compensacao DateTime @default(now())
  observacao       String?

  @@index([fornecedor_id])
  @@index([conta_pagar_id])
  @@index([conta_receber_id])
  @@map("fornecedor_compensacoes")
}

model compras {
  id Int @id @default(autoincrement())

  // ‚úÖ define o tipo da compra (constantes)
  tipo_compra String // "INSUMOS" | "CLIENTE_AMBIENTE"

  // ‚úÖ venda s√≥ quando for cliente/ambiente
  venda_id Int?
  venda    vendas? @relation(fields: [venda_id], references: [id], onDelete: Cascade)

  fornecedor_id Int
  fornecedor    Fornecedores @relation(fields: [fornecedor_id], references: [id])

  venda_item_id Int?
  venda_item    vendas_itens? @relation(fields: [venda_item_id], references: [id], onDelete: SetNull)

  status String

  data_compra DateTime @default(now())

  valor_total Decimal @default(0.00) @db.Decimal(10, 2)

  criado_em     DateTime @default(now())
  atualizado_em DateTime @updatedAt

  itens   compras_itens[]
  rateios compras_rateio[]

  @@index([tipo_compra])
  @@index([venda_id])
  @@index([fornecedor_id])
  @@map("compras")
}

model compras_itens {
  id Int @id @default(autoincrement())

  compra_id Int
  compra    compras @relation(fields: [compra_id], references: [id], onDelete: Cascade)

  // ‚úÖ NOVO: v√≠nculo com produto
  produto_id Int?
  produto    produtos? @relation(fields: [produto_id], references: [id], onDelete: SetNull)

  quantidade     Decimal @default(1.00) @db.Decimal(10, 2)
  unidade        String
  valor_unitario Decimal @default(0.00) @db.Decimal(10, 2)
  valor_total    Decimal @default(0.00) @db.Decimal(10, 2)

  criado_em DateTime @default(now())

  @@index([compra_id])
  @@index([produto_id]) // ‚úÖ NOVO
  @@map("compras_itens")
}

model compras_rateio {
  id Int @id @default(autoincrement())

  compra_id Int
  compra    compras @relation(fields: [compra_id], references: [id], onDelete: Cascade)

  // ambiente por snapshot (texto igual ao vendas_itens.nome_ambiente)
  nome_ambiente String

  // quanto desse total foi alocado nesse ambiente
  valor_alocado Decimal @default(0.00) @db.Decimal(10, 2)

  criado_em DateTime @default(now())

  @@unique([compra_id, nome_ambiente]) // ‚úÖ impede duplicar o mesmo ambiente na mesma compra
  @@index([compra_id])
  @@index([nome_ambiente])
  @@map("compras_rateio")
}
model permissoes {
  id         Int      @id @default(autoincrement())
  chave      String   @unique
  descricao  String?
  criado_em  DateTime @default(now())

  usuarios   usuarios_permissoes[]

  @@map("permissoes")
}

model usuarios_permissoes {
  id            Int      @id @default(autoincrement())
  usuario_id    Int
  permissao_id  Int
  criado_em     DateTime @default(now())

  usuario       usuarios    @relation(fields: [usuario_id], references: [id])
  permissao     permissoes  @relation(fields: [permissao_id], references: [id])

  @@unique([usuario_id, permissao_id])
  @@index([usuario_id])
  @@index([permissao_id])
  @@map("usuarios_permissoes")
}
