import{x as Ve,y as we,f as c,h as te,g as S,j as K,i as he,m as V,s as i,r as C,E as q,o as N,A as b,e as p,b as t,c as O,H as Te,d as w,p as le,l as L,u as X,R as Pe,t as h,S as Ue,V as ne,q as W,U as se,W as qe,Q as Z,X as Oe}from"./index-CH22lQIC.js";const Re={class:"p-8 lg:p-12"},De={class:"grid grid-cols-12 gap-6 items-end bg-slate-50/50 dark:bg-slate-800/20 p-6 rounded-2xl"},Le={class:"col-span-12 md:col-span-4"},$e={class:"flex gap-3"},Be={key:0,class:"space-y-6"},je={class:"grid grid-cols-12 gap-6 items-end"},ze={class:"col-span-12"},Fe={class:"space-y-6"},Qe={class:"flex items-center justify-between gap-4"},He={class:"grid grid-cols-12 gap-6 items-end bg-slate-50/50 dark:bg-slate-800/20 p-6 rounded-2xl border border-border-ui"},Ge={class:"col-span-12"},Ke={key:0,class:"border border-border-ui rounded-2xl overflow-hidden"},Xe={class:"py-2"},We={class:"font-black text-slate-700 uppercase text-xs"},Ze={key:0,class:"mt-1 text-[10px] font-bold uppercase tracking-wider text-slate-400"},Je={class:"text-xs font-bold text-slate-500"},Ye={class:"text-sm font-black text-slate-800"},ea={class:"flex justify-end gap-2"},aa={class:"flex items-center justify-between p-6 bg-slate-50 dark:bg-slate-800/20 border-t border-border-ui"},oa={class:"text-lg font-black"},ra={class:"pt-10 mt-6 border-t border-border-ui"},ta={class:"flex items-center justify-between gap-4"},la={key:2},ia={__name:"[id]",setup(na){const $=Ve(),B=we(),j=c(!1),z=c(!1),F=c(!1),v=c("INSUMOS"),f=c(null),y=c(null),A=te({data_compra:new Date().toISOString().split("T")[0]}),_=c([]),T=c([]),R=c(!1),Q=c([]),H=c([]),P=c([]),U=c(new Map),I=c([]),g=c(null),x=c(!1),J=c(0),l=te({produto_id:null,nome_produto:"",marca:null,cor:null,medida:null,unidade:"",quantidade:1,valorUnitarioMask:"0,00"}),m=S(()=>$.params.id&&$.params.id!=="novo"),M=S(()=>m.value?Number($.params.id):null),Y=S(()=>{const a=_.value.reduce((e,o)=>e+Number(o.valor_total||0),0);return E(a)}),ie=S(()=>Array.isArray(Q.value)?Q.value:[]),ue=S(()=>(Array.isArray(H.value)?H.value:[]).map(a=>{var e;return{value:a.id,label:((e=a.cliente)==null?void 0:e.nome_completo)||`Venda #${a.id}`}})),de=S(()=>(Array.isArray(I.value)?I.value:[]).map(a=>({value:a.nome,label:a.nome}))),ce=S(()=>!f.value||!A.data_compra?!1:v.value==="INSUMOS"?!0:v.value==="CLIENTE_AMBIENTE"?!(!y.value||!x.value&&!g.value):!1),me=[{key:"nome_produto",label:"Produto"},{key:"quantidade",label:"Qtd",align:"center"},{key:"valor_unitario",label:"V. Unit."},{key:"valor_total",label:"Subtotal"},{key:"acoes",label:"",width:"120px",align:"right"}];function E(a){return Math.round((Number(a)+Number.EPSILON)*100)/100}function G(){Object.assign(l,{produto_id:null,nome_produto:"",marca:null,cor:null,medida:null,unidade:"",quantidade:1,valorUnitarioMask:"0,00"}),J.value++}function pe(a){const e=E(Number(a||0));if(!x.value)return[{nome_ambiente:String(g.value||"").trim(),valor_alocado:e}];const o=(I.value||[]).map(d=>String((d==null?void 0:d.nome)||"").trim()).filter(Boolean),s=Array.from(new Set(o));if(!s.length){const d=String(g.value||"").trim();return d?[{nome_ambiente:d,valor_alocado:e}]:[{nome_ambiente:"GERAL",valor_alocado:e}]}if(e===0)return s.map(d=>({nome_ambiente:d,valor_alocado:0}));const u=E(Math.floor(e/s.length*100)/100);let r=0;return s.map((d,k)=>{const D=k===s.length-1?E(e-r):u;return r=E(r+D),{nome_ambiente:d,valor_alocado:D}})}const ee=a=>{const e=Number(a),o=U.value.get(e);o&&(l.produto_id=e,l.nome_produto=o.nome_produto,l.marca=o.marca??null,l.cor=o.cor??null,l.medida=o.medida??null,l.unidade=o.unidade||"",l.valorUnitarioMask=se(Number(o.valor_unitario||0)))},ve=()=>{if(!l.produto_id){i.warn("Selecione um produto.");return}if(!l.unidade){i.warn("Produto sem unidade. Defina a unidade no cadastro do produto.");return}const a=Number(l.quantidade||0);if(a<=0){i.warn("Informe a quantidade.");return}const e=qe(l.valorUnitarioMask);if(e<=0){i.warn("Informe o valor unitário.");return}const o=E(e*a);_.value.push({_key:Date.now()+Math.random(),produto_id:Number(l.produto_id),nome_produto:l.nome_produto,marca:l.marca,cor:l.cor,medida:l.medida,unidade:l.unidade,quantidade:a,valor_unitario:e,valor_total:o,id:null}),G(),i.success("Item adicionado!")},be=async a=>{const e=_.value.find(s=>s._key===a);!e||!await W.show("Remover Item","Tem certeza que deseja remover este item?")||(m.value&&e.id&&T.value.push(e.id),_.value=_.value.filter(s=>s._key!==a),i.info("Item removido."))},fe=async a=>{const e=_.value.find(o=>o._key===a);e&&(l.produto_id=e.produto_id,l.nome_produto=e.nome_produto,l.marca=e.marca??null,l.cor=e.cor??null,l.medida=e.medida??null,l.unidade=e.unidade||"",l.quantidade=Number(e.quantidade||1),l.valorUnitarioMask=se(Number(e.valor_unitario||0)),m.value&&e.id&&T.value.push(e.id),_.value=_.value.filter(o=>o._key!==a),i.info("Item carregado para edição."))},ae=async()=>{var a;if(!y.value){I.value=[],g.value=null;return}try{const e=await ne.listarAmbientes(Number(y.value)),o=(e==null?void 0:e.data)??e;I.value=Array.isArray(o)?o:[]}catch(e){console.log("[COMPRA] erro ao carregar ambientes:",((a=e==null?void 0:e.response)==null?void 0:a.data)||e),I.value=[],i.error("Erro ao carregar ambientes da venda.")}},_e=()=>{if(!f.value)return i.error("Selecione um fornecedor."),!1;if(!A.data_compra)return i.error("Informe a data da compra."),!1;if(v.value==="CLIENTE_AMBIENTE"){if(!y.value)return i.error("Selecione a venda."),!1;if(!x.value&&!g.value)return i.error("Selecione o ambiente (ou marque todos)."),!1}return!0},ge=async()=>{const a=m.value?"compras.editar":"compras.criar";if(!V(a))return i.error("Acesso negado.");!_e()||!await W.show(m.value?"Atualizar Compra":"Salvar Compra",m.value?`Deseja atualizar a Compra #${M.value}?`:"Deseja confirmar e salvar esta compra?")||await ye()},ye=async()=>{var e,o,s,u;const a=m.value?"compras.editar":"compras.criar";if(!V(a))return i.error("Acesso negado.");z.value=!0;try{const r=E(Number(Y.value||0)),d={tipo_compra:v.value,fornecedor_id:Number(f.value),venda_id:v.value==="CLIENTE_AMBIENTE"?Number(y.value):null,data_compra:A.data_compra,valor_total:r,itens:_.value.map(k=>({...k.id?{id:Number(k.id)}:{},produto_id:Number(k.produto_id),quantidade:Number(k.quantidade),unidade:k.unidade,valor_unitario:Number(k.valor_unitario),valor_total:Number(k.valor_total)})),...m.value&&T.value.length?{itens_remover_ids:T.value.map(Number)}:{}};v.value==="CLIENTE_AMBIENTE"&&(d.rateios=pe(r)),await Z.salvar(M.value,d),i.success(m.value?"Compra atualizada!":"Compra criada!"),B.push("/compras")}catch(r){console.log("[COMPRA] erro salvar:",(e=r==null?void 0:r.response)==null?void 0:e.status,(o=r==null?void 0:r.response)==null?void 0:o.data,r),i.error(((u=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:u.message)||"Erro ao salvar compra.")}finally{z.value=!1}},xe=async()=>{var e,o;if(!V("compras.excluir"))return i.error("Acesso negado.");if(await W.show("Excluir Compra",`Deseja realmente excluir a Compra #${M.value}?`)){F.value=!0;try{await Z.remover(M.value),i.success("Compra excluída!"),B.push("/compras")}catch(s){i.error(((o=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:o.message)||"Erro ao excluir compra.")}finally{F.value=!1}}},oe=async()=>{var a;if(!f.value){P.value=[],U.value=new Map;return}try{const e=await Oe.listar({fornecedor_id:Number(f.value)}),o=(e==null?void 0:e.data)??e,s=Array.isArray(o)?o:[];P.value=s.map(r=>({value:r.id,label:`${r.nome_produto}${r.marca?` • ${r.marca}`:""}${r.cor?` • ${r.cor}`:""}${r.medida?` • ${r.medida}`:""}`}));const u=new Map;s.forEach(r=>{u.set(Number(r.id),{id:r.id,nome_produto:r.nome_produto,marca:r.marca??null,cor:r.cor??null,medida:r.medida??null,unidade:r.unidade??"",valor_unitario:Number(r.valor_unitario||0)})}),U.value=u}catch(e){console.log("[COMPRA] erro carregarProdutos:",((a=e==null?void 0:e.response)==null?void 0:a.data)||e),P.value=[],U.value=new Map,i.error("Erro ao carregar produtos do fornecedor.")}},ke=async()=>{var o,s;const a=await Z.buscar(M.value),e=(a==null?void 0:a.data)??a;if(!e)throw new Error("Compra não encontrada");v.value=e.tipo_compra||"INSUMOS",f.value=e.fornecedor_id??null,y.value=e.venda_id??null,A.data_compra=((o=e.data_compra)==null?void 0:o.split("T")[0])||A.data_compra,_.value=(e.itens||[]).map(u=>({...u,_key:u.id?`db-${u.id}`:Date.now()+Math.random(),valor_unitario:Number(u.valor_unitario||0),valor_total:Number(u.valor_total||0)})),T.value=[],v.value==="CLIENTE_AMBIENTE"&&y.value&&(await ae(),Array.isArray(e.rateios)&&e.rateios.length===1?(x.value=!1,g.value=((s=e.rateios[0])==null?void 0:s.nome_ambiente)||null):Array.isArray(e.rateios)&&e.rateios.length>1&&(x.value=!0,g.value=null))};function re(a){return[a==null?void 0:a.marca,a==null?void 0:a.cor,a==null?void 0:a.medida,a==null?void 0:a.unidade].map(o=>String(o||"").trim()).filter(Boolean).join(" • ")}const Ne=async()=>{j.value=!0;try{const[a,e]=await Promise.all([Ue.select(),ne.listar()]);Q.value=Array.isArray(a==null?void 0:a.data)?a.data:[],H.value=Array.isArray(e==null?void 0:e.data)?e.data:[],m.value&&await ke()}catch(a){console.log("[COMPRA] erro carregarDadosIniciais:",a),i.error("Erro ao carregar dados.")}finally{j.value=!1}};function Ce(){if(!f.value){i.warn("Selecione um fornecedor primeiro.");return}R.value=!0}function Ae(){R.value=!1}async function Ie(a){await oe();const e=(a==null?void 0:a.data)??a,o=Number(e==null?void 0:e.id);o&&(l.produto_id=o,ee(o)),R.value=!1}return K(v,a=>{a!=="CLIENTE_AMBIENTE"&&(y.value=null,I.value=[],g.value=null,x.value=!1)}),K(y,async()=>{x.value=!1,g.value=null,await ae()}),K(f,async a=>{if(!a){P.value=[],U.value=new Map,G();return}G(),await oe()}),he(async()=>{const a=m.value?"compras.editar":"compras.criar";if(!V(a)){i.error("Acesso negado."),B.push("/compras");return}await Ne()}),(a,e)=>{const o=C("PageHeader"),s=C("Loading"),u=C("Button"),r=C("SearchInput"),d=C("Input"),k=C("CustomCheckbox"),D=C("Table"),Ee=C("QuickCreateProduto"),Se=C("Card");return N(),q(Se,{class:"mt-4 mb-8 mx-2 lg:mx-4 shadow-xl rounded-[2.5rem] overflow-hidden animate-page-in"},{default:b(()=>[p(o,{title:m.value?`Compra #${M.value}`:"Nova Compra",subtitle:"Registre uma nova entrada de materiais.",icon:"pi pi-shopping-cart",backTo:"/compras",class:"border-b border-border-ui"},null,8,["title"]),t("div",Re,[j.value?(N(),q(s,{key:0})):(N(),O("form",{key:1,class:"space-y-10",onSubmit:Te(ge,["prevent"]),autocomplete:"off"},[t("div",De,[t("div",Le,[e[13]||(e[13]=t("label",{class:"block text-[10px] font-black uppercase tracking-widest text-slate-500 mb-2 ml-1"}," Destino do Gasto ",-1)),t("div",$e,[p(u,{type:"button",variant:"secondary",class:le(["flex-1 justify-center !h-12 !rounded-xl",v.value==="INSUMOS"?"ring-2 ring-brand-primary bg-brand-primary/10":""]),onClick:e[0]||(e[0]=n=>v.value="INSUMOS")},{default:b(()=>[...e[11]||(e[11]=[t("span",{class:"text-[10px] font-black uppercase"},"Estoque",-1)])]),_:1},8,["class"]),p(u,{type:"button",variant:"secondary",class:le(["flex-1 justify-center !h-12 !rounded-xl",v.value==="CLIENTE_AMBIENTE"?"ring-2 ring-brand-primary bg-brand-primary/10":""]),onClick:e[1]||(e[1]=n=>v.value="CLIENTE_AMBIENTE")},{default:b(()=>[...e[12]||(e[12]=[t("span",{class:"text-[10px] font-black uppercase"},"Venda",-1)])]),_:1},8,["class"])])]),p(r,{class:"col-span-12 md:col-span-5",modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=n=>f.value=n),mode:"select",label:"Fornecedor *",options:ie.value,required:"",placeholder:"Selecione..."},null,8,["modelValue","options"]),p(d,{class:"col-span-12 md:col-span-3",modelValue:A.data_compra,"onUpdate:modelValue":e[3]||(e[3]=n=>A.data_compra=n),label:"Data da Compra *",type:"date",required:""},null,8,["modelValue"])]),v.value==="CLIENTE_AMBIENTE"?(N(),O("div",Be,[e[14]||(e[14]=t("div",{class:"relative"},[t("div",{class:"absolute inset-0 flex items-center"},[t("div",{class:"w-full border-t border-border-ui/50"})]),t("div",{class:"relative flex justify-center"},[t("span",{class:"bg-bg-page dark:bg-slate-900 px-4 text-xs font-bold uppercase tracking-wider text-slate-400"}," Cliente x Ambiente ")])],-1)),t("div",je,[p(r,{class:"col-span-12 md:col-span-6",modelValue:y.value,"onUpdate:modelValue":e[4]||(e[4]=n=>y.value=n),mode:"select",label:"Venda *",options:ue.value,required:"",placeholder:"Selecione..."},null,8,["modelValue","options"]),p(r,{class:"col-span-12 md:col-span-6",modelValue:g.value,"onUpdate:modelValue":e[5]||(e[5]=n=>g.value=n),mode:"select",label:"Ambiente",options:de.value,required:!x.value,readonly:x.value,placeholder:"Selecione..."},null,8,["modelValue","options","required","readonly"]),t("div",ze,[p(k,{label:"Aplicar em TODOS os ambientes do mês",description:"Quando marcado, o rateio será dividido entre todos os ambientes desta venda.","model-value":x.value,"onUpdate:modelValue":e[6]||(e[6]=n=>{x.value=n,n&&(g.value=null)})},null,8,["model-value"])])])])):w("",!0),t("div",Fe,[e[21]||(e[21]=t("div",{class:"relative"},[t("div",{class:"absolute inset-0 flex items-center"},[t("div",{class:"w-full border-t border-border-ui/50"})]),t("div",{class:"relative flex justify-center"},[t("span",{class:"bg-bg-page dark:bg-slate-900 px-4 text-xs font-bold uppercase tracking-wider text-slate-400"}," Itens da Nota ")])],-1)),t("div",Qe,[e[16]||(e[16]=t("p",{class:"text-xs font-bold uppercase tracking-wider text-slate-400"}," Adicione os itens da compra ",-1)),p(u,{variant:"ghost",size:"sm",type:"button",class:"text-[10px] font-black uppercase tracking-widest hover:bg-brand-primary/5 text-brand-primary",onClick:Ce},{default:b(()=>[...e[15]||(e[15]=[t("i",{class:"pi pi-plus-circle mr-2"},null,-1),L(" Produto não cadastrado? ",-1)])]),_:1})]),t("div",He,[(N(),q(r,{class:"col-span-12 md:col-span-6",key:J.value,modelValue:l.produto_id,"onUpdate:modelValue":[e[7]||(e[7]=n=>l.produto_id=n),ee],mode:"select",label:"Produto",options:P.value,placeholder:"Selecione..."},null,8,["modelValue","options"])),p(d,{class:"col-span-6 md:col-span-2",modelValue:l.quantidade,"onUpdate:modelValue":e[8]||(e[8]=n=>l.quantidade=n),label:"Qtd",type:"number",placeholder:"0"},null,8,["modelValue"]),p(d,{class:"col-span-6 md:col-span-4",modelValue:l.valorUnitarioMask,"onUpdate:modelValue":e[9]||(e[9]=n=>l.valorUnitarioMask=n),label:"Valor Unitário",placeholder:"0,00",onInput:e[10]||(e[10]=n=>l.valorUnitarioMask=X(Pe)(n.target.value))},null,8,["modelValue"]),t("div",Ge,[p(u,{variant:"primary",size:"lg",class:"w-full !rounded-xl",type:"button",onClick:ve},{default:b(()=>[...e[17]||(e[17]=[L(" ADICIONAR ITEM ",-1)])]),_:1})])]),_.value.length?(N(),O("div",Ke,[p(D,{columns:me,rows:_.value,boxed:""},{"cell-nome_produto":b(({row:n})=>[t("div",Xe,[t("div",We,h(n.nome_produto),1),re(n)?(N(),O("div",Ze,h(re(n)),1)):w("",!0)])]),"cell-valor_unitario":b(({value:n})=>[t("span",Je," R$ "+h(Number(n).toLocaleString("pt-br",{minimumFractionDigits:2})),1)]),"cell-valor_total":b(({value:n})=>[t("span",Ye," R$ "+h(Number(n).toLocaleString("pt-br",{minimumFractionDigits:2})),1)]),"cell-acoes":b(({row:n})=>[t("div",ea,[p(u,{variant:"ghost",size:"sm",type:"button",onClick:Me=>fe(n._key)},{default:b(()=>[...e[18]||(e[18]=[t("i",{class:"pi pi-pencil text-[12px]"},null,-1)])]),_:1},8,["onClick"]),p(u,{variant:"ghost",size:"sm",type:"button",class:"text-red-500 hover:bg-red-50",onClick:Me=>be(n._key)},{default:b(()=>[...e[19]||(e[19]=[t("i",{class:"pi pi-trash text-[12px]"},null,-1)])]),_:1},8,["onClick"])])]),_:1},8,["rows"]),t("div",aa,[e[20]||(e[20]=t("span",{class:"text-[10px] font-black uppercase tracking-widest text-slate-400"},"Total da Compra",-1)),t("span",oa," R$ "+h(Number(Y.value).toLocaleString("pt-br",{minimumFractionDigits:2})),1)])])):w("",!0)]),t("div",ra,[t("div",ta,[e[24]||(e[24]=t("div",null,null,-1)),X(V)(m.value?"compras.editar":"compras.criar")?(N(),q(u,{key:0,variant:"primary",size:"lg",type:"submit",loading:z.value,disabled:!ce.value},{default:b(()=>[e[22]||(e[22]=t("i",{class:"pi pi-save mr-2 text-[12px]"},null,-1)),L(" "+h(m.value?"ATUALIZAR COMPRA":"SALVAR COMPRA"),1)]),_:1},8,["loading","disabled"])):w("",!0),m.value&&X(V)("compras.excluir")?(N(),q(u,{key:1,type:"button",variant:"danger",size:"lg",loading:F.value,onClick:xe},{default:b(()=>[...e[23]||(e[23]=[t("i",{class:"pi pi-trash mr-2 text-[12px]"},null,-1),L(" EXCLUIR ",-1)])]),_:1},8,["loading"])):w("",!0),m.value?w("",!0):(N(),O("div",la))])])],32))]),p(Ee,{open:R.value,"fornecedor-id":f.value?Number(f.value):null,"texto-inicial":"",onClose:Ae,onCreated:Ie},null,8,["open","fornecedor-id"])]),_:1})}}};export{ia as default};
//# sourceMappingURL=_id_-Bxq9GWmd.js.map
