{"version":3,"file":"useauth-BQLIh4i2.js","sources":["../../src/services/useauth.js"],"sourcesContent":["import { ref, computed } from 'vue'\r\nimport api from '@/services/api'\r\nimport storage from '@/utils/storage'\r\n\r\nconst SESSION_KEY = 'ACASA_SESSION_ALIVE'\r\n\r\n// Estado Global (Singleton)\r\nconst token = ref(storage.getToken())\r\nconst usuarioLogado = ref(storage.getUser())\r\nconst loading = ref(false)\r\nconst error = ref('')\r\n\r\n// ✅ boot check: roda UMA vez quando o arquivo é importado\r\n// useAuth.js\r\n\r\n// ✅ Boot Check: Se abriu o site e não tem a marcação de sessão ativa, DESTROI TUDO.\r\nif (token.value && !sessionStorage.getItem(SESSION_KEY)) {\r\n  // Limpa storage físico imediatamente\r\n  storage.removeToken()\r\n  storage.removeUser()\r\n  \r\n  // Limpa estado reativo\r\n  token.value = null\r\n  usuarioLogado.value = null\r\n\r\n  // Força o navegador a ir para o login antes mesmo de carregar o resto\r\n  window.location.href = '/login'\r\n} else if (token.value) {\r\n  // Se tem token e a sessão já estava marcada, mantém viva\r\n  sessionStorage.setItem(SESSION_KEY, '1')\r\n}\r\n\r\nconst isStandalone = () =>\r\n  window.matchMedia?.('(display-mode: standalone)')?.matches ||\r\n  window.navigator?.standalone === true\r\n\r\n\r\nif (!window.__ACASA_HIDE_LOGOUT_BOUND__) {\r\n  window.__ACASA_HIDE_LOGOUT_BOUND__ = true\r\n\r\n  window.addEventListener('pagehide', () => {\r\n    if (!isStandalone()) return\r\n    if (!token.value) return\r\n\r\n    fetch('/api/auth/logout', { method: 'POST', credentials: 'include', keepalive: true }).catch(() => {})\r\n\r\n    sessionStorage.removeItem(SESSION_KEY)\r\n    storage.removeToken()\r\n    storage.removeUser()\r\n    token.value = null\r\n    usuarioLogado.value = null\r\n  })\r\n}\r\n\r\n\r\n\r\nexport function useAuth() {\r\n  const isAuthenticated = computed(() => !!token.value)\r\n\r\n  const permissoes = computed(() => {\r\n    const user = usuarioLogado.value\r\n    return Array.isArray(user?.permissoes) ? user.permissoes : []\r\n  })\r\n\r\n  const temAcesso = (chave) => {\r\n    const user = usuarioLogado.value\r\n    if (!user) return false\r\n\r\n    const ehAdmin = user.usuario === 'Ana.P' || permissoes.value.includes('ADMIN')\r\n    if (ehAdmin) return true\r\n\r\n    return permissoes.value.includes(chave)\r\n  }\r\n\r\n  async function login({ usuario, senha }) {\r\n    loading.value = true\r\n    error.value = ''\r\n    try {\r\n      const { data } = await api.post('/auth/login', { usuario, senha })\r\n\r\n      storage.setToken(data.token)\r\n      storage.setUser(data.usuario)\r\n\r\n      // ✅ marca sessão viva\r\n      sessionStorage.setItem(SESSION_KEY, '1')\r\n\r\n      token.value = data.token\r\n      usuarioLogado.value = data.usuario\r\n\r\n      return data\r\n    } catch (e) {\r\n      error.value = e?.response?.data?.message || 'Credenciais inválidas'\r\n      throw e\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n  }\r\n\r\n  async function solicitarCadastro(dados) {\r\n    loading.value = true\r\n    try {\r\n      const { data } = await api.post('/auth/cadastro', dados)\r\n      return data\r\n    } catch (e) {\r\n      error.value = e?.response?.data?.message || 'Erro ao solicitar cadastro'\r\n      throw e\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n  }\r\n\r\n  async function esqueciSenha(email) {\r\n    loading.value = true\r\n    error.value = ''\r\n    try {\r\n      const { data } = await api.post('/auth/esqueci-senha', { email })\r\n      return data\r\n    } catch (e) {\r\n      error.value = e?.response?.data?.message || 'Erro ao enviar recuperação'\r\n      throw e\r\n    } finally {\r\n      loading.value = false\r\n    }\r\n  }\r\n\r\n// Mude de: async function alterarSenha(senha_atual, senha_nova)\r\n// Para:\r\nasync function alterarSenha(dados) { // dados = { senha_atual, senha_nova }\r\n  loading.value = true\r\n  error.value = ''\r\n  try {\r\n    // Passamos o objeto 'dados' direto para o axios\r\n    const { data } = await api.post('/auth/alterar-senha', dados)\r\n    return data\r\n  } catch (e) {\r\n    error.value = e?.response?.data?.message || 'Erro ao alterar senha'\r\n    throw e\r\n  } finally {\r\n    loading.value = false\r\n  }\r\n}\r\n\r\n  async function syncMe() {\r\n    const tokenLocal = storage.getToken()\r\n    if (!tokenLocal) return null\r\n\r\n    const { data } = await api.get('/auth/me')\r\n    storage.setUser(data)\r\n    usuarioLogado.value = data\r\n    return data\r\n  }\r\n\r\n  // ✅ único logout (async)\r\n  async function logout() {\r\n    try {\r\n      await api.post('/auth/logout')\r\n    } catch {}\r\n\r\n    sessionStorage.removeItem(SESSION_KEY)\r\n\r\n    storage.removeToken()\r\n    storage.removeUser()\r\n    token.value = null\r\n    usuarioLogado.value = null\r\n    window.location.href = '/login'\r\n  }\r\n\r\n  return {\r\n    token,\r\n    usuarioLogado,\r\n    isAuthenticated,\r\n    loading,\r\n    error,\r\n    login,\r\n    logout,\r\n    solicitarCadastro,\r\n    esqueciSenha,\r\n    alterarSenha,\r\n    temAcesso,\r\n    permissoes,\r\n    syncMe,\r\n  }\r\n}\r\n\r\n\r\n\r\n"],"names":["SESSION_KEY","token","ref","storage","usuarioLogado","loading","error","isStandalone","_b","_a","_c","useAuth","isAuthenticated","computed","permissoes","user","temAcesso","chave","login","usuario","senha","data","api","e","solicitarCadastro","dados","esqueciSenha","email","alterarSenha","syncMe","logout"],"mappings":"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"}