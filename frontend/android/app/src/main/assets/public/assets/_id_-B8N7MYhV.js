import{x as de,y as me,f as g,g as D,h as H,i as ve,C as pe,aa as v,r as y,c as P,o as k,e as p,A as d,b as t,E as T,d as O,u as b,m as l,l as S,w as fe,v as be,t as A,P as X,D as U,s as m,q as F}from"./index-CH22lQIC.js";const _e={class:"page-container"},ge={class:"p-6 space-y-8"},ye={class:"space-y-3"},xe={class:"max-w-2xl"},ke={class:"space-y-4"},Ae={class:"p-6 rounded-3xl border border-slate-100 bg-white space-y-6"},Ie={class:"grid grid-cols-12 gap-6"},we={class:"col-span-12 md:col-span-8"},he={class:"col-span-12 md:col-span-4"},qe={class:"col-span-12"},Oe={class:"col-span-12"},Ce={class:"flex justify-end"},Se={key:0},Ee={class:"whitespace-pre-line"},Ne={class:"whitespace-pre-line font-bold"},Re={class:"font-bold"},De={class:"grid grid-cols-12 gap-6"},Te={class:"col-span-12 lg:col-span-7 space-y-3"},Ve={class:"flex items-center justify-between"},$e={class:"flex items-center gap-2"},Be={key:0,class:"text-[10px] font-bold text-slate-400 uppercase tracking-wider"},Me={class:"rounded-3xl border border-slate-200 bg-white overflow-hidden min-h-[220px]"},ze={class:"flex flex-col"},Pe={class:"text-xs font-black text-slate-800"},Ue={class:"text-[10px] font-bold text-slate-400 uppercase tracking-wider"},Fe={class:"flex justify-end gap-2"},je={class:"col-span-12 lg:col-span-5 space-y-4"},Le={class:"p-6 rounded-3xl border border-slate-100 bg-white"},Qe={class:"text-3xl font-black"},Ge={__name:"[id]",setup(He){const x=de(),I=me();g(!1);const c=g(null),f=D(()=>c.value||x.params.id),w=D(()=>String(f.value)==="novo"||!f.value),h=()=>w.value?"orcamentos.criar":"orcamentos.editar",j=g([]),E=g(!1),q=g(null),r=H({cliente_id:null,ambientes:[]}),s=H({nome_ambiente:"",descricao:"",valor_unitario:"",observacao:""}),V=g([]),$=g(!1),B=g(null),G=[{key:"nome",label:"ARQUIVO"},{key:"acoes",label:"",align:"right",width:"220px"}],Z=[{key:"nome_ambiente",label:"Item/Ambiente"},{key:"descricao",label:"Acabamento"},{key:"observacao",label:"Observações"},{key:"valor_unitario",label:"Valor",align:"right"},{key:"acoes",label:"",width:"140px",align:"right"}];function J(a){let e=a.target.value.replace(/\D/g,"");if(!e){s.valor_unitario="";return}s.valor_unitario=(Number(e)/100).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}function M(a){return typeof a=="number"?a:Number(String(a).replace("R$","").replace(/\./g,"").replace(",",".").trim())||0}const L=D(()=>r.ambientes.map((a,e)=>({...a,__idx:e}))),K=D(()=>r.ambientes.reduce((a,e)=>a+M(e.valor_unitario),0));async function W(){if(!s.nome_ambiente)return;const a=await R();if(!a)return;const e=q.value!==null?r.ambientes[q.value]||{}:{},o={nome_ambiente:s.nome_ambiente,descricao:s.descricao,observacao:s.observacao||"",valor_unitario:M(s.valor_unitario),valor_total:M(s.valor_unitario)};if(e.id)await v.atualizarItem(a,e.id,o),r.ambientes.splice(q.value,1,{...e,...o});else{const n=await v.adicionarItem(a,o);r.ambientes.push({id:n.data.id,...o})}Object.keys(s).forEach(n=>s[n]=""),q.value=null}function Y(a){const e=r.ambientes[a];Object.assign(s,{...e,valor_unitario:Number(e.valor_unitario||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"})}),q.value=a}async function ee(a){const e=r.ambientes[a];await F.show("Remover Item",`Deseja remover "${(e==null?void 0:e.nome_ambiente)||"ITEM"}"?`)&&await ae(a)}async function ae(a){const e=r.ambientes[a];e!=null&&e.id&&f.value&&String(f.value)!=="novo"&&await v.removerItem(f.value,e.id),r.ambientes.splice(a,1)}async function te(){if(!l("orcamentos.excluir"))return m.error("Acesso negado.");await F.show("Excluir Orçamento",`Deseja excluir permanentemente o Orçamento #${f.value}?`)&&(await v.remover(f.value),I.push("/orcamentos"))}async function oe(){var e;const a=h();if(!l(a))return m.error("Acesso negado.");if(!r.cliente_id)return alert("Selecione um cliente.");if(!r.ambientes.length)return alert("Adicione ao menos 1 item.");E.value=!0;try{let o=f.value;w.value?(o=(await v.criar({cliente_id:r.cliente_id})).data.id,c.value=o,I.replace(`/orcamentos/${o}`)):await v.atualizar(o,{cliente_id:r.cliente_id});for(const n of r.ambientes){const u={nome_ambiente:n.nome_ambiente,descricao:n.descricao,observacao:n.observacao||"",valor_unitario:Number(n.valor_unitario||0),valor_total:Number(n.valor_unitario||0)};if(n.id)await v.atualizarItem(o,n.id,u);else{const _=await v.adicionarItem(o,u);n.id=(e=_.data)==null?void 0:e.id}}await I.push("/orcamentos")}finally{E.value=!1}}async function N(){const a=c.value;if(!a||String(a)==="novo"){V.value=[];return}$.value=!0;try{const e=await U.listar({ownerType:"ORCAMENTO",ownerId:Number(String(a).replace(/\D/g,"")),categoria:"ANEXO"});V.value=Array.isArray(e==null?void 0:e.data)?e.data:[]}finally{$.value=!1}}function ne(a){const e=String(c.value||"").replace(/\D/g,""),o=encodeURIComponent(`/orcamentos/${e||"novo"}`),n=encodeURIComponent((a==null?void 0:a.nome)||(a==null?void 0:a.filename)||"ARQUIVO"),u=encodeURIComponent((a==null?void 0:a.mime_type)||"");I.push(`/arquivos/${a.id}?name=${n}&type=${u}&backTo=${o}`)}async function ie(a){var o,n;if(!l("arquivos.excluir")||!l(h()))return m.error("Acesso negado.");if(await F.show("Excluir arquivo?","Esta ação não pode ser desfeita."))try{await U.remover(Number(a)),m.success("Arquivo removido."),await N()}catch(u){m.error(((n=(o=u==null?void 0:u.response)==null?void 0:o.data)==null?void 0:n.message)||"Erro ao excluir arquivo.")}}async function re(){if(!l(h())||!l("arquivos.criar"))return m.error("Acesso negado.");if(await R(),await Promise.resolve(),!B.value)return m.error("Input de arquivo não montado.");B.value.click()}async function se(a){var n,u,_;const e=(n=a.target.files)==null?void 0:n[0];if(a.target.value="",!e)return;if(!l("arquivos.criar")||!l(h()))return m.error("Acesso negado.");const o=await R();if(o)try{await U.upload({ownerType:"ORCAMENTO",ownerId:Number(String(o).replace(/\D/g,"")),categoria:"ANEXO",file:e}),m.success("Arquivo anexado."),await N()}catch(C){m.error(((_=(u=C==null?void 0:C.response)==null?void 0:u.data)==null?void 0:_.message)||"Erro ao anexar arquivo.")}}async function le(){if(!l("orcamentos.ver"))return m.error("Acesso negado.");const a=await R();if(a)try{const{data:e}=await v.abrirPdf(a),o=e==null?void 0:e.arquivoId;if(!o)return m.error("Não retornou arquivoId.");await I.push({path:`/arquivos/${String(o).replace(/\D/g,"")}`,query:{name:`ORCAMENTO_${String(a).replace(/\D/g,"")}.pdf`,type:"application/pdf"}})}catch{m.error("Erro ao gerar PDF.")}}async function R(){var o;if(!r.cliente_id)return alert("Selecione um cliente."),null;if(c.value)return c.value;const a=(o=x.params)==null?void 0:o.id;if(a&&String(a)!=="novo")return c.value=a,c.value;const e=await v.criar({cliente_id:r.cliente_id});return c.value=e.data.id,await I.replace(`/orcamentos/${c.value}`),await N(),c.value}return ve(async()=>{var o;const{data:a}=await pe.listar();j.value=(a||[]).map(n=>({label:n.nome_completo||n.razao_social||`ID #${n.id}`,value:n.id}));const e=(o=x.query)==null?void 0:o.cliente_id;if(e&&String(x.params.id)==="novo"&&(r.cliente_id=Number(String(e).replace(/\D/g,""))||null),x.params.id&&String(x.params.id)!=="novo"){c.value=x.params.id;const n=await v.detalhar(c.value);r.cliente_id=n.data.cliente_id,r.ambientes=n.data.itens||[],await N()}}),(a,e)=>{const o=y("Button"),n=y("PageHeader"),u=y("SearchInput"),_=y("Input"),C=y("TableActions"),Q=y("Table"),ce=y("FormActions"),ue=y("Card");return k(),P("div",_e,[p(ue,null,{default:d(()=>[p(n,{title:w.value?"Novo Orçamento":`Orçamento #${f.value}`,subtitle:"Cadastro operacional do orçamento",icon:"pi pi-briefcase",backTo:"/orcamentos"},{actions:d(()=>[b(l)("orcamentos.ver")?(k(),T(o,{key:0,variant:"primary",size:"sm",type:"button",onClick:le,disabled:E.value||w.value},{default:d(()=>[...e[5]||(e[5]=[t("i",{class:"pi pi-file-pdf mr-2"},null,-1),S(" GERAR PDF ",-1)])]),_:1},8,["disabled"])):O("",!0)]),_:1},8,["title"]),t("div",ge,[t("div",ye,[e[6]||(e[6]=t("div",{class:"text-xs font-black uppercase tracking-widest text-slate-500"}," Cliente ",-1)),t("div",xe,[p(u,{modelValue:r.cliente_id,"onUpdate:modelValue":e[0]||(e[0]=i=>r.cliente_id=i),mode:"select",options:j.value,label:"Quem é o cliente?",placeholder:"Pesquisar cliente..."},null,8,["modelValue","options"])])]),e[15]||(e[15]=t("div",{class:"h-px bg-slate-100"},null,-1)),t("div",ke,[e[9]||(e[9]=t("div",{class:"text-xs font-black uppercase tracking-widest text-slate-500"}," Itens do Orçamento ",-1)),t("div",Ae,[t("div",Ie,[t("div",we,[p(_,{modelValue:s.nome_ambiente,"onUpdate:modelValue":e[1]||(e[1]=i=>s.nome_ambiente=i),label:"ITEM / AMBIENTE",placeholder:"Ex: COZINHA"},null,8,["modelValue"])]),t("div",he,[p(_,{modelValue:s.valor_unitario,"onUpdate:modelValue":e[2]||(e[2]=i=>s.valor_unitario=i),label:"VALOR",onInput:J,placeholder:"R$ 0,00"},null,8,["modelValue"])]),t("div",qe,[e[7]||(e[7]=t("label",{class:"text-[10px] font-black uppercase text-slate-400 mb-2 block ml-1"}," ACABAMENTO / DESCRIÇÃO (TÓPICOS) ",-1)),fe(t("textarea",{"onUpdate:modelValue":e[3]||(e[3]=i=>s.descricao=i),rows:"4",class:"w-full p-4 rounded-2xl bg-slate-50 border border-slate-100 text-sm outline-none resize-none",placeholder:`* MDF azul
* MDF verde
* puxador perfil`},null,512),[[be,s.descricao]])]),t("div",Oe,[p(_,{modelValue:s.observacao,"onUpdate:modelValue":e[4]||(e[4]=i=>s.observacao=i),label:"OBSERVAÇÕES TÉCNICAS",placeholder:"MDF Branco TX, puxador perfil..."},null,8,["modelValue"])])]),t("div",Ce,[p(o,{variant:"primary",type:"button",onClick:W},{default:d(()=>[e[8]||(e[8]=t("i",{class:"pi pi-plus-circle mr-2"},null,-1)),S(" "+A(q.value!==null?"Atualizar Item":"Adicionar Item"),1)]),_:1})])]),L.value.length>0?(k(),P("div",Se,[p(Q,{columns:Z,rows:L.value,boxed:""},{"cell-descricao":d(({row:i})=>[t("div",Ee,A(i.descricao||"-"),1)]),"cell-observacao":d(({row:i})=>[t("div",Ne,A(i.observacao||"-"),1)]),"cell-valor_unitario":d(({row:i})=>[t("span",Re,A(b(X).currency(i.valor_unitario)),1)]),"cell-acoes":d(({row:i})=>[p(C,{id:i.id??i.__idx,"perm-edit":"orcamentos.editar","perm-delete":"orcamentos.editar",onEdit:z=>Y(i.__idx),onDelete:z=>ee(i.__idx)},null,8,["id","onEdit","onDelete"])]),_:1},8,["rows"])])):O("",!0)]),e[16]||(e[16]=t("div",{class:"h-px bg-slate-100"},null,-1)),t("div",De,[t("div",Te,[t("div",Ve,[e[11]||(e[11]=t("div",{class:"text-xs font-black uppercase tracking-widest text-slate-500"}," Arquivos ",-1)),t("div",$e,[t("input",{ref_key:"fileInput",ref:B,type:"file",class:"hidden",onChange:se},null,544),b(l)(h())&&b(l)("arquivos.criar")?(k(),T(o,{key:0,size:"sm",variant:"ghost",type:"button",onClick:re},{default:d(()=>[...e[10]||(e[10]=[t("i",{class:"pi pi-upload mr-1"},null,-1),S(" ADICIONAR ",-1)])]),_:1})):O("",!0)])]),w.value?(k(),P("p",Be," Se necessário, o orçamento será criado automaticamente ao anexar (cliente obrigatório). ")):O("",!0),t("div",Me,[p(Q,{columns:G,rows:V.value,loading:$.value,"empty-text":"Nenhum arquivo anexado.",boxed:!1},{"cell-nome":d(({row:i})=>[t("div",ze,[t("span",Pe,A(i.nome||i.filename),1),t("span",Ue,A(i.mime_type||"ARQUIVO"),1)])]),"cell-acoes":d(({row:i})=>[t("div",Fe,[b(l)("arquivos.ver")||b(l)("orcamentos.ver")?(k(),T(o,{key:0,variant:"secondary",size:"sm",type:"button",onClick:z=>ne(i)},{default:d(()=>[...e[12]||(e[12]=[S(" Ver ",-1)])]),_:1},8,["onClick"])):O("",!0),b(l)("arquivos.excluir")&&b(l)(h())?(k(),T(o,{key:1,variant:"danger",size:"sm",type:"button",onClick:z=>ie(i.id)},{default:d(()=>[...e[13]||(e[13]=[S(" Excluir ",-1)])]),_:1},8,["onClick"])):O("",!0)])]),_:1},8,["rows","loading"])])]),t("div",je,[t("div",Le,[e[14]||(e[14]=t("div",{class:"text-[10px] font-black uppercase text-slate-400 tracking-widest mb-2"}," Total do Orçamento ",-1)),t("div",Qe,A(b(X).currency(K.value)),1)]),p(ce,{"is-edit":!w.value,"loading-save":E.value,onSave:oe,onDelete:te,class:"flex-row-reverse"},null,8,["is-edit","loading-save"])])])])]),_:1})])}}};export{Ge as default};
//# sourceMappingURL=_id_-B8N7MYhV.js.map
